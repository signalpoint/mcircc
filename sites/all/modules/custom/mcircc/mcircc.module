<?php

/**
 * Implements hook_menu_alter();
 */
function mcircc_menu_alter(&$items) {
  //dpm($items);
  // Example - disable the page at node/add
  //$items['node/%node/view']['access callback'] = 'mcircc_node_access';
  //$items['node/%node/view']['access arguments'] = array('view', 1);
}

/**
* Implements hook_entity_info_alter().
*/
function mcircc_entity_info_alter(&$entity_info) {
  // Add a custom display mode to the user entity, and profile2 entity.
  $entity_info['user']['view modes']['mcircc_member_directory'] = array(
    'label' => t('MCIRCC Member Directory'),
    'custom settings' => TRUE
  );
  /*$entity_info['profile2']['view modes']['mcircc_member_directory'] = array(
    'label' => t('MCIRCC Member Directory'),
    'custom settings' => TRUE
  );*/
}

/**
 * Implements hook_form_alter().
 */
function mcircc_form_alter(&$form, &$form_state, &$form_id) {
  
  global $user;
  
  //drupal_set_message($form_id);
  //dpm($form);
  
  // Attach an after build handler.
  $form['#after_build'][] = 'mcircc_form_after_build';
  
  // Make alterations for regular users...
  if (!mcircc_admin()) {
    
    // Hide the input format section under wysiwygs for non admins.
    if (isset($form['body'])) {
      $form['body']['#after_build'][] = 'mcircc_form_textarea_after_build';
    }
    if (isset($form['comment_body'])) {
      $form['comment_body']['#after_build'][] = 'mcircc_form_textarea_after_build';
    }
    if (isset($form['field_user_biography'])) {
      $form['field_user_biography']['#after_build'][] = 'mcircc_form_textarea_after_build';
    }
  }
  // Make alterations for admin users...
  else {
  }
  
  // Make alterations for all users.
  switch ($form_id) {
    case 'user_profile_form':
      //dpm($form);
      // Make the organisation element on the address field required.
      $form['field_user_address'][LANGUAGE_NONE][0]['organisation_block']['organisation_name']['#required'] = TRUE;
      // Change the links titles to "Academic Publish Articles" and "Michigan Experts Profile".
      $form['field_user_research_interests'][LANGUAGE_NONE][0]['#default_value']['title'] = 'Academic Published Articles';
      $form['field_user_research_interests'][LANGUAGE_NONE][1]['#default_value']['title'] = 'Michigan Experts Profile';
      break;
    case 'question_node_form':
      // On new nodes, check the notification box by default.
      if (!$form['nid']['#value']) {
        $form['field_notify_p'][LANGUAGE_NONE]['#default_value'] = 1;
      }
      break;
    case 'file_node_form':
      $form['title']['#description'] = t(
        'Enter an <em>optional</em> title for your document. This helps others easily locate your
        file through search, and helps others better understand the file\'s
        content at a glance. If left blank, a title will automatically be generated for you.');
      break;
  }

}

/**
 *
 */
function mcircc_form_after_build($form, &$form_state) {
  
  //drupal_set_message($form['#form_id']);
  //dpm($form);
  
  switch ($form['#form_id']) {
    
    case 'user_profile_form':
      
      //dpm($form);
      
      // Disable the link titles.
      // @TODO - Not working.
      $form['field_user_research_interests'][LANGUAGE_NONE][0]['title']['#disabled'] = TRUE;
      $form['field_user_research_interests'][LANGUAGE_NONE][1]['title']['#disabled'] = TRUE;
      
      break;
  }

  return $form;
}

function mcircc_form_textarea_after_build(&$form) {
  $form[LANGUAGE_NONE][0]['format']['#prefix'] = '<div style="display: none;">';
  $form[LANGUAGE_NONE][0]['format']['#suffix'] = '</div>';
  return $form;
}

/**
 * Implements hook_node_access().
 */
function mcircc_node_access($node, $op, $account) {
  // Restrict access to all but a few nodes for anonymous users.
  if ($account->uid == 0 && $op == 'view') {
    $nodes = array(
      'page' => array(
        1218 /* home page */
      )
    );
    foreach ($nodes as $bundle => $nids) {
      if ($node->type == $bundle && in_array($node->nid, $nids)) {
        return NODE_ACCESS_ALLOW;
      }
    }
  }
  else { return NODE_ACCESS_IGNORE; }
  return NODE_ACCESS_DENY;
}

/**
 * Returns true if the current user is considered an MCIRCC admin.
 */
function mcircc_admin() {
  global $user;
  $admin = FALSE;
  if (
    $user->uid != 0 &&
    (
      $user->uid == 1 ||
      in_array('administrator', $user->roles) ||
      in_array('mcircc administrator', $user->roles)
    )
  ) { $admin = TRUE; }
  return $admin;
}

/**
 * Given a Views result row, this will render a user's credentials next to their
 * display name, separated by comma.
 */
function mcircc_user_display_name_with_credentials($row) {
  //dpm($row);
  if (!isset($row->field_field_user_display_name[0])) { return ''; }
  $text = $row->field_field_user_display_name[0]['rendered']['#markup'];
  if (!empty($row->field_field_user_credentials)) {
    $credentials = array();
    foreach ($row->field_field_user_credentials as $credential) {
      $credentials[] = $credential['rendered']['#markup'];
    }
    $text .= ', ' . implode(',', $credentials);
  }
  return $text;
}
